# 仮想通貨価格変動予測 仕様書（spec2）

## 目的

2023-11-10〜2025-11-09の相関分析および因果性検定の結果を踏まえ、BTC-USDの価格変動を予測するモデル化フローを定義する。主たる成果物は「1日先のBTCログリターン（`btc_log_return`）」「3日移動平均リターン」「方向性（二値: Up/Down）」の予測であり、運用時には7日先までのマルチホライズン推定にも拡張できる設計とする。

---

## 背景知見（分析結果の抜粋）

- 価格系列（Open/High/Low/Close）は互いに0.99前後で強い多重共線性を持つ。
- マクロ指標のうち `nasdaq` と `gold`、`m2_supply` がBTC価格と0.87〜0.97の高い共分散を示し、`dxy` は -0.39 と逆相関。
- `fear_greed_index` の単純相関は小さい一方、RandomForest重要度では4位 (0.08) と非線形寄与が確認できる。
- グレンジャー因果性検定では `BTC-USD_low`（lag=2, p=0.010）、`BTC-USD_open`（lag=2, p=0.044）が最も低いp値を示し、価格自身の自己回帰性が強い。
- `nasdaq`（lag=1, p≈0.118）や `BTC-USD_volume`（lag=6, p≈0.126）がBTCリターンに遅行影響を与える兆候があり、短期と週次のラグ特徴の併用が有効と考えられる。
- PCAでは第1主成分で分散の65%を説明しており、多重共線性対策として潜在因子を活用する余地がある。

---

## 予測対象とスコープ

- 対象資産: BTC-USD（日次足、主目標）。**クロスアセット相関**: ETH, SOL, BNB等の主要コインも並行収集し、相互依存性を特徴量化する（集合的予測の研究知見を反映）。
- 目的変数:
  - `y_1d`: 24時間後（UTC 00:00基準）の `btc_log_return`（定義: t=当日UTC 00:00の終値→t+24hの終値のclose-to-closeログリターン）
  - `y_3d_avg`: 3日移動平均（t+1〜t+3）のログリターン
  - `y_dir`: 24時間後の終値基準での価格方向（上昇=1/下落=0）
- 予測頻度: 日次（UTC 00:00基準、24時間365日稼働）
- 推論ホライズン: 1日先（必須）、3日先（準必須）、7日先（任意拡張）
- **週末対応**: マクロ指標（nasdaq, us10y等）は土日更新されないため、週末予測時は直近平日値を利用。週末の予測精度低下を評価指標で個別モニタリングする。
- **精度目標**: Directional Accuracy 57-60%を目指す（最新研究ベンチマークを参考）。ただし暗号資産市場の非定常性により長期維持には継続的再学習が必須。
- **タイムアライメント**: すべての特徴量は時点tまで（t含む）の情報で生成し、経済イベントは「実際の公表UTC時刻」に基づき当日または翌日に割当てる（Look-ahead防止）。

---

## 運用KPI目標（評価の合格基準）

- 方向性（`y_dir`）: 1D 0.57以上、3D 0.58以上、7D 0.55以上（各90日ローリングで信頼区間付与）
- 回帰（`y_1d`）: RMSEが過去最良モデルの+10%以内、Diebold-Mariano検定で有意優位（5%水準）
- トレーディング: 年率Sharpe > 0.7、最大ドローダウン < 15%、Directional Hit Ratio > 0.55

---

## データ要件

### 1. 基本価格データ（取引所REST API）
- 参照エンドポイント: Bitfinex, Binance, Coinbase, Kraken, OKX, KuCoin, Gate.io, Bitstamp, Gemini, Crypto.com など  
  （`ref/crypt-arbitrage/crypt-arbitrage.py` の `EXCHANGE_APIS` を基盤とし、必要に応じて拡張）
- 取得項目: 取引所別のスポット最終価格・出来高・スプレッド（取引所が返す場合）
- **クロスアセット収集**: BTC-USDに加え、ETH-USD, SOL-USD, BNB-USDも同時収集し、相互依存性を捉える（C2P2研究の集合的予測アプローチ）
- **データ品質管理**:
  - 最小有効取引所数: 7社以上のティッカーが揃わない場合は該当タイムスタンプを欠損扱い
  - 異常値除外: 中央値から±3%を超える取引所価格は動的外れ値として集計から除外
  - 欠損補完: 3時間以内の欠損は線形補間、それ以上は前方埋め（最大24時間まで）。2連続タイムスタンプで欠損が連続する場合はバックフィル打ち切り
- 集約ロジック: 取引所別VWAPの「中央値」を基本とし、最良買値/売値・スプレッド指標も算出（USDT建/USD建ミックス時は為替・ペッグ乖離を正規化）
- 追加生成: `btc_log_return`, `volume_log_return`, 取引所間スプレッド、裁定余剰率
- **スプレッド・裁定余剰率の定義**:
  - 取引所間スプレッド: `(最高価格 - 最低価格) / 中央値`
  - 裁定余剰率: `(最高価格 - 最低価格) - (手数料0.2% × 2 + スリッページ0.1% × 2)`

### 2. マクロ指標
- `nasdaq`, `gold`, `m2_supply`, `us10y`, `dxy`
- 差分/対数差を取り、マクロのトレンド要素と変化率を双方利用
- **欠損補完ルール**:
  - 日次指標（nasdaq, gold, us10y, dxy）: 前方埋め最大7日まで（週末・祝日考慮）
  - 週次・月次指標（m2_supply）: 前方埋め最大30日まで、それ以上は線形補間または欠損扱い
- **イベント・サプライズ特徴**:
  - 主要経済指標の「発表UTC時刻」を管理し、サプライズ（実績−予想）のz-scoreを特徴として付与
  - `m2_supply` 等の低頻度系列には「新値反映フラグ」を追加（更新日に1を付与）

### 3. センチメント・マルチモーダルデータ
- `fear_greed_index`（日次、必須）
- **ニュース・SNSセンチメント（準必須、CoinCLIP/CryptoPulse研究を参考）**:
  - CryptoPanic API: 仮想通貨ニュースのセンチメントスコア（Positive/Negative/Neutral比率）
  - LunarCrush API: Twitter/Reddit/Discord活動指標（投稿数、いいね数、ユニークユーザ数）
  - Santiment API: Twitter Volume、Social Dominance等（APIキーが用意できる場合）
- **取得頻度**: 日次で集計し、7日/14日ローリング平均を算出
- **品質管理**: ニュース/SNSはソース多重度、重複除外、言語別バイアス補正（英語優勢時のウエイト低減等）を適用

### 4. オンチェーン・デリバティブ（拡張）
- オンチェーン: CoinMetrics Community API、CryptoQuant、Dune Export など無償もしくは低コストのソースを優先（例: `mvrv_z_score`, `realized_cap`, `exchange_balance`）
- デリバティブ: Binance Futures (`/fapi/v1/fundingRate`, `/fapi/v1/openInterestHist`)、Bybit (`/derivatives/v3/public/funding/history`)、Deribit 等
- 取得頻度を日次に抑え、API制限に応じたキャッシュ・再取得ロジックを実装

### 5. メタ情報
- 祝日・週末フラグ、ボラティリティレジーム（例: VIX代替としてNASDAQボラティリティ指数）
- **経済イベントカレンダー（準必須、外部ショック対策）**:
  - FOMC会合日、CPI/雇用統計発表日、中央銀行政策発表など主要イベントをフラグ化
  - イベント前後3日間のフラグを別途生成し、ボラティリティ急変期の予測精度低下に対応

---

## 特徴量設計

1. **ラグ特徴**
   - 価格系列: lag 1〜7を生成。特にlag1〜2は自己回帰性を捉える主要特徴。
   - 出来高: lag 1〜7に加え、週次合計（lag7ロールアップ）を算出（Grangerでlag6が示唆されたため）。
   - **クロスアセット相関**: ETH/SOL/BNBのログリターンlag 1〜3を追加し、BTCとの相互依存性を捉える（C2P2研究）。
   - マクロ: `nasdaq`, `us10y`, `dxy`, `gold`, `m2_supply` はlag 1〜3を生成。
   - センチメント: `fear_greed_index` はlag 1〜5を生成し、変化率（Δ1, Δ3）も計算。ニュース/SNSセンチメントスコアのlag 1〜3も追加。

2. **テクニカル指標**
   - 移動平均（SMA7, SMA21, EMA9, EMA26）
   - ボリンジャーバンド（20日）
   - RSI (14), MACD (12, 26, 9)
   - 日中レンジ比 (`(high - low)/close`)

3. **ボラティリティ & レジーム指標**
   - 10日/30日ローリング標準偏差
   - Garman-Klassボラティリティ、Parkinson、Realized Vol
   - 価格 vs 20日SMA の乖離率
   - **ボラティリティレジーム判定**: 30日ローリング標準偏差が過去90日の75パーセンタイルを超える場合を「高ボラ期」とフラグ化（CryptoPulse研究の動的調整メカニズムを参考）
   - **レジーム検出強化**: HMM/Markov Switching、Drawdownレジーム、SPX/VIX・DXYの合成によるレジームIDを生成し、メタ特徴として注入

4. **多重共線性対策**
   - 価格系列とマクロ系列それぞれにPCAを適用し、累積90%を満たす主成分を抽出。
   - LightGBM等の木系モデル用にそのまま原変数も保持するが、線形モデルではPCのみを利用。

5. **ターゲットエンコーディング的特徴**
   - `y_dir` の7日ローリング勝率（**lag 8日以上でシフト**: t-15〜t-8の7日間の勝率を使用し、未来情報の混入を防止）
   - `btc_log_return` の14日ローリング平均/標準偏差（**計算ウィンドウ: t-14〜t-1**）

6. **休日・時間特徴**
   - 曜日ダミー、月初/月末フラグ
   - 主要経済イベント日カレンダー（FOMC, CPI）を外部テーブル化（任意）

---

## モデル戦略

1. **前処理パイプライン**
   - 欠損補完（線形補間＋前方補完）
   - 標準化: 線形モデル・ニューラルネットではStandardScalerを適用。木系モデルでは不要。
   - 訓練/検証分割: 時系列ウォークフォワード（例: 2023-11〜2024-09をtrain、2024-10〜2025-03をval、2025-04〜2025-11をtest）

2. **ベースラインモデル**
   - 方向性: ロジスティック回帰＋時変パラメータ（TVP）を比較対象に含め、確率校正のベースラインとする
   - 回帰: Ridge/Lasso をベースラインとして追加
   - 時系列: `ARIMA`（p=2, d=0, q=2 初期値）で `btc_log_return` を予測
   - マルチ変量: `VAR`（価格と主要マクロ）で相互依存性を確認

3. **勾配ブースティングモデル**
   - LightGBM (regression) で `y_1d`, `y_3d_avg` を同時推定
   - 目的変数 `y_dir` はLightGBM (binary) で分類
   - ハイパーパラメータはOptunaで探索（例: learning_rate, num_leaves, feature_fraction, lag上限）
   - **過学習対策の推奨パラメータ**:
     - `min_data_in_leaf` ≥ 20（葉ごとの最小サンプル数）
     - `max_depth` ≤ 6（木の深さ制限）
     - `feature_fraction` ∈ [0.6, 0.9]（各木で使う特徴量の割合）
     - `lambda_l1` ≥ 0.1, `lambda_l2` ≥ 0.1（正則化）
     - 特徴選択: SHAP値が上位30%の特徴のみ最終モデルで使用

4. **シーケンスモデル（条件付き導入）**
   - **導入条件**: LightGBMで目標精度（Directional Accuracy > 0.57）を達成後に検討
   - Temporal Fusion Transformer (TFT) もしくは LSTM Encoder-Decoder
   - 入力ウィンドウ: 過去56日、出力ウィンドウ: 1/3/7日
   - `fear_greed_index` やマクロのラグを動的要因として組み込み
   - 実装・チューニング・推論コストが高いため、初期スコープでは「任意拡張」として扱う

5. **アンサンブル**
   - ベースライン、LightGBM、TFTの予測を重み付き平均（重みは検証スコアに基づき逆分散重みで算出）
   - **ボラティリティレジーム適応**: 高ボラ期はセンチメント・ボラティリティ指標の重みを増加、低ボラ期はマクロ指標の重みを増加（CryptoPulse研究）
   - 方向性（Up/Down）はLightGBM分類の結果を優先し、閾値調整でPrecision/Recallを最適化
   - **メタ学習**: スタッキング（メタ学習器はLogit/Elastic Net）を候補に追加

6. **説明可能性**
   - Tree系モデルはSHAP値を算出し、寄与度上位10特徴をレポート
   - TFTは注意重みからタイムステップ貢献度を抽出

---

## 学習・評価設計

- **バックテスト**: Purged/Embargoed エキスパンド型ウォークフォワード（train追加→検証→テスト）を**少なくとも12ウィンドウ（月次分割）**実施（Lopez de Prado）。Embargo=3日。
  - 例: 2023-11〜2024-10をtrain、2024-11をval、2024-12をtest → 次ウィンドウは2023-11〜2024-11をtrain、2024-12をval、2025-01をtest
  - **検証期間中は再学習禁止**: 各ウィンドウのvalおよびtest期間中はモデルパラメータを固定し、Look-ahead biasを排除。モデル選択はvalのみ、testは最後のホールドアウト1回で評価
- **指標**:
  - 回帰: RMSE, MAE, MAPE, R²
  - 方向性: Accuracy, Precision, Recall, Mathews Correlation Coefficient (MCC)
  - トレーディング指標:
    - **戦略ルール**: `y_dir=1` なら翌日始値で買い、`y_dir=0` なら売り（またはノーポジション）。手数料0.1%、スリッページ考慮。ポジションサイズは資産の10%固定に加え、ボラティリティ連動のリスクパリティ案を比較（min/maxリスク制約）
    - Sharpe比（年率換算、無リスク金利2%と仮定）
    - 最大ドローダウン（MDD）
    - Directional Hit Ratio（方向的中率）
    - 累積PnL（ドル建て）
- **閾値と確率校正**:
  - 方向性分類はPlatt ScalingまたはIsotonic Regressionで確率校正
  - 実効コスト（手数料/スリッページ）を織り込んだ「期待値最大化」閾値をvalで探索
- **統計検定**: Diebold-Mariano検定でベースラインとの優位性を確認。
- **モデル監視**: 最近60日間の予測誤差をロギングし、閾値超過で再学習をトリガ。データドリフト（PSI）、ターゲットドリフト、外れ値検知の監視も追加

---

## 出力・レポート

| ファイル | 内容 |
| --- | --- |
| `forecast_results.csv` | 予測値・実績値・誤差・方向性を記録 |
| `model_summary.md` | モデル設定、評価指標、SHAPトップ10、改善メモ |
| `feature_importance.png` | LightGBMの上位寄与特徴（SHAPバー） |
| `backtest_equity.png` | 単純トレード戦略のエクイティカーブ |
| `tft_attention_heatmap.png` | TFT注意重みの時系列可視化（任意） |

---

## 運用フロー

1. 毎日UTC 00:15に `ref/crypt-arbitrage/crypt-arbitrage.py` をジョブ化し、複数取引所のスポット価格を収集・集約する。
2. 続いて `crypto_kpi_analysis.py` でマクロ・センチメント・オンチェーン／デリバティブ（Binance/Bybit/CoinMetrics 等）を取得し、`.env` で管理するAPIキーを読み込む。
3. データが揃い次第、特徴量生成→モデル推論→結果保存を自動ジョブ（例: Airflow, Prefect）で実行。
4. 週次（月曜）に再学習タスクを走らせ、Optuna探索は月次に制限して過学習を防ぐ。
5. **モデル更新とロールバック戦略**:
   - 更新後、ベリフィケーションジョブで評価指標が閾値（例: RMSE < 0.025, Directional Accuracy > 0.55）を満たすか確認
   - 直近30日のRMSEが過去最良モデルの1.2倍を超えた場合、即座に前バージョンにロールバック
   - モデルバージョニングはMLflowまたはDVCで管理し、各バージョンに実験ID・ハイパーパラメータ・評価指標を紐付ける
6. 監視ダッシュボード（Streamlit想定）に最新予測・評価指標・データ取得状況・モデル更新履歴を表示。データ取得の指数バックオフ、レート制限遵守、永続キャッシュ（raw/中間/特徴の階層化）状況も可視化
7. 再現性: 固定seed、deterministic設定、Docker化、pip-compileで依存固定、MLflow/DVCで完全再現

---

## 今後の拡張

- **強化学習ベースのトレーディングエージェント（Coinvisor研究を参考）**:
  - DQN/PPOを用いたリアルタイム適応型の売買戦略を開発
  - 予測精度だけでなく、リスク調整後リターン（Sharpe比）を最大化する報酬設計
  - 初期スコープでは教師あり学習で精度検証後、強化学習へ段階的移行
- **クロスアセット予測への拡張（C2P2研究を参考）**:
  - BTC単体ではなく、ETH/SOL/BNB等の複数通貨を同時予測する集合的分類モデル
  - 通貨間の相互依存性をグラフニューラルネットワーク（GNN）で明示的にモデル化
- SantimentやGlassnodeプレミアムAPIを導入し、オンチェーン/ソーシャルデータのラグ特徴を充実。
- ローリング相関をモニタリングし、特徴量セットの自動リバランス（例: 直近90日で相関が急変した特徴をペナルティ）。
- 合成指標（例: マクロ・センチメントを組み合わせた複合スコア）をAutoMLで探索。
- ETF需給（フロー、プレミアム）やオプションSkewなど、新規デリバティブデータを組み込む。
- **リアルタイム対応は初期スコープ外**: 日次予測で十分な精度を確認後、必要に応じて4時間足データの並行整備を検討。HFTや裁定取引など明確な要件が定まってから着手する。

---

## コンプライアンスと秘密管理

- すべてのAPI・サイトの利用規約・ライセンス順守（ニュース/SNS含む）。規約変更の定期モニタリング
- 機密情報は秘密管理基盤で運用（`.env`はローカル開発のみ）。環境毎に優先度ルールを明示（本番の環境変数 > 秘密管理 > `.env`）


